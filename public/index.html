<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Pick Me Game (Realtime)</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
    }
    .layout {
      display: flex;
      gap: 16px;
      width: 1100px;
      max-width: 100%;
    }
    .container {
      flex: 3;
      background: #ffffff;
      border-radius: 12px;
      padding: 20px 24px 28px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .admin-panel {
      flex: 1.4;
      background: #ffffff;
      border-radius: 12px;
      padding: 16px 18px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      display: none;
      align-self: flex-start;
    }
    h1 { margin-top: 0; text-align: center; color: #333; }
    h2 { margin-top: 0; font-size: 18px; margin-bottom: 10px; }
    .row { display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 16px; }
    .col { flex: 1; min-width: 220px; }
    label { display: block; font-size: 14px; margin-bottom: 4px; color: #555; }
    input[type="text"], input[type="number"] {
      width: 100%; padding: 8px 10px; border-radius: 6px;
      border: 1px solid #ccc; font-size: 14px;
    }
    button {
      padding: 9px 14px; border-radius: 6px; border: none;
      cursor: pointer; font-weight: 600; font-size: 14px; margin-right: 8px;
    }
    button.primary { background: #2f80ed; color: #fff; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .card {
      border-radius: 10px; padding: 12px 14px;
      background: #fafafa; border: 1px solid #e2e2e2;
      margin-bottom: 12px; font-size: 14px;
    }
    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fit,minmax(190px,1fr));
      gap: 10px; font-size: 14px;
    }
    .stat { padding: 8px 10px; background: #f9f9f9; border-radius: 8px; border: 1px solid #e3e3e3; }
    .stat .label { display:block; color:#777; font-size:12px; margin-bottom:2px; }
    .players-table { width:100%; border-collapse:collapse; font-size:14px; margin-top:4px; }
    .players-table th, .players-table td {
      border:1px solid #ddd; padding:6px 8px; text-align:left;
    }
    .players-table th { background:#f0f0f0; }
    .info { font-size:13px; color:#777; margin-top:4px; }
    .highlight { color:#e67e22; font-weight:bold; }
    .winner-message { font-size:15px; margin-top:6px; }
    .admin-note { font-size:12px; color:#777; margin-top:4px; }
  </style>
</head>
<body>
<div class="layout">

  <!-- GAME -->
  <div class="container">
    <h1>Pick Me Game (Realtime)</h1>

    <div class="card">
      <div class="row">
        <div class="col">
          <label for="playerName">T√™n ng∆∞·ªùi ch∆°i:</label>
          <input type="text" id="playerName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n (nh·∫≠p 'admin' ƒë·ªÉ m·ªü b·∫£ng ƒëi·ªÅu khi·ªÉn)">
        </div>
        <div class="col" style="align-self:flex-end;">
          <button class="primary" id="setPlayerBtn">X√°c nh·∫≠n / ƒê·ªïi ng∆∞·ªùi ch∆°i</button>
        </div>
      </div>
      <div class="info">
        Ng∆∞·ªùi ch∆°i hi·ªán t·∫°i: <span id="currentPlayerName" class="highlight">ch∆∞a ch·ªçn</span>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="col">
          <label for="betAmount">S·ªë v√†ng mu·ªën ƒë·∫∑t:</label>
          <input type="number" id="betAmount" min="1" value="10">
        </div>
        <div class="col" style="align-self:flex-end;">
          <button class="primary" id="betBtn">ƒê·∫∑t v√†ng</button>
        </div>
      </div>
      <div class="info">
        M·ªói ng∆∞·ªùi c√≥ th·ªÉ ƒë·∫∑t nhi·ªÅu l·∫ßn trong c√πng 1 v√°n, v√†ng s·∫Ω ƒë∆∞·ª£c c·ªông d·ªìn.
      </div>
    </div>

    <div class="card">
      <div><strong>Ng∆∞·ªùi ch∆°i may m·∫Øn v√°n tr∆∞·ªõc:</strong>
        <span id="lastWinner">ch∆∞a c√≥</span>
      </div>

      <div class="stats-grid" style="margin-top:10px;">
        <div class="stat">
          <span class="label">T·ªïng s·ªë v√†ng (pot)</span>
          <span id="totalGold">0</span>
        </div>
        <div class="stat">
          <span class="label">T·ªïng s·ªë ng∆∞·ªùi tham gia</span>
          <span id="totalPlayers">0</span>
        </div>
        <div class="stat">
          <span class="label">S·ªë v√†ng b·∫°n ƒë√£ tham gia</span>
          <span id="myGold">0</span>
        </div>
        <div class="stat">
          <span class="label">X√°c su·∫•t tr√∫ng c·ªßa b·∫°n</span>
          <span id="myChance">0.00%</span>
        </div>
        <div class="stat">
          <span class="label">Th·ªùi gian tr·∫£ k·∫øt qu·∫£</span>
          <span id="timeRemaining">ch∆∞a b·∫Øt ƒë·∫ßu</span>
        </div>
        <div class="stat">
          <span class="label">Tr·∫°ng th√°i v√°n</span>
          <span id="roundStatus">ƒêang ch·ªù ƒë·ªß ng∆∞·ªùi (‚â• 2)</span>
        </div>
      </div>

      <div class="winner-message" id="winnerMessage"></div>
    </div>

    <div class="card">
      <strong>Danh s√°ch ng∆∞·ªùi ch∆°i trong v√°n hi·ªán t·∫°i:</strong>
      <table class="players-table">
        <thead>
        <tr>
          <th>#</th><th>T√™n</th><th>S·ªë v√†ng</th><th>T·ªâ l·ªá th·∫Øng (%)</th>
        </tr>
        </thead>
        <tbody id="playersTableBody">
        </tbody>
      </table>
    </div>
  </div>

  <!-- ADMIN -->
  <div class="admin-panel" id="adminPanel">
    <h2>‚öô B·∫£ng ƒëi·ªÅu khi·ªÉn (Admin)</h2>

    <div class="card">
      <label for="configDuration">Th·ªùi gian m·ªói v√°n (gi√¢y):</label>
      <input type="number" id="configDuration" min="5" value="60">

      <label for="configMinBet" style="margin-top:10px;">Min s·ªë v√†ng m·ªói l·∫ßn ƒë·∫∑t:</label>
      <input type="number" id="configMinBet" min="1" value="1">

      <button class="primary" id="saveConfigBtn" style="margin-top:10px;">L∆∞u c·∫•u h√¨nh</button>

      <div class="admin-note">
        ‚Ä¢ Th·ªùi gian m·ªõi √°p d·ª•ng cho c√°c v√°n ti·∫øp theo.<br>
        ‚Ä¢ Min v√†ng m·ªõi √°p d·ª•ng ngay cho c√°c l·∫ßn ƒë·∫∑t sau.
      </div>
    </div>

    <div class="card" style="font-size:13px;">
      <strong>Info:</strong><br>
      ‚Ä¢ C·∫ßn t·ªëi thi·ªÉu 2 ng∆∞·ªùi c√≥ v√†ng &gt; 0 ƒë·ªÉ v√°n b·∫Øt ƒë·∫ßu.<br>
      ‚Ä¢ Ng∆∞·ªùi th·∫Øng ƒë∆∞·ª£c ch·ªçn theo t·ªâ l·ªá: v√†ng c√° nh√¢n / t·ªïng v√†ng.
    </div>
  </div>

</div>

<script>
  const socket = io();

  let currentPlayerName = null;
  let latestState = null;

  // DOM
  const currentPlayerNameEl = document.getElementById('currentPlayerName');
  const lastWinnerEl = document.getElementById('lastWinner');
  const totalGoldEl = document.getElementById('totalGold');
  const totalPlayersEl = document.getElementById('totalPlayers');
  const myGoldEl = document.getElementById('myGold');
  const myChanceEl = document.getElementById('myChance');
  const timeRemainingEl = document.getElementById('timeRemaining');
  const roundStatusEl = document.getElementById('roundStatus');
  const playersTableBody = document.getElementById('playersTableBody');
  const winnerMessageEl = document.getElementById('winnerMessage');
  const adminPanelEl = document.getElementById('adminPanel');
  const configDurationInput = document.getElementById('configDuration');
  const configMinBetInput = document.getElementById('configMinBet');
  const betAmountInput = document.getElementById('betAmount');

  // nh·∫≠n state t·ª´ server
  socket.on('state', (state) => {
    latestState = state;
    renderState();
  });

  // nh·∫≠n winner khi v√°n k·∫øt th√∫c
  socket.on('winner', (data) => {
    if (!data) {
      winnerMessageEl.textContent = 'Kh√¥ng c√≥ ai ƒë·∫∑t v√†ng, v√°n b·ªã h·ªßy.';
    } else {
      winnerMessageEl.textContent =
        `üéâ Ng∆∞·ªùi th·∫Øng v√°n n√†y l√† ${data.name},ƒë√£ ƒë·∫∑t ${data.bet}, ƒÉn to√†n b·ªô pot: ${data.pot} v√†ng!`;
    }
  });

  function renderState() {
    if (!latestState) return;
    const { config, round } = latestState;

    lastWinnerEl.textContent = round.lastWinner || 'ch∆∞a c√≥';
    totalGoldEl.textContent = round.totalGold;
    totalPlayersEl.textContent = round.totalPlayers;

    // t√≠nh th√¥ng tin c√° nh√¢n
    let myGold = 0;
    let myChance = 0;
    if (currentPlayerName) {
      const me = round.players.find(p => p.name === currentPlayerName);
      if (me) {
        myGold = me.gold;
        if (round.totalGold > 0) {
          myChance = (me.gold / round.totalGold) * 100;
        }
      }
    }
    myGoldEl.textContent = myGold;
    myChanceEl.textContent = myChance.toFixed(2) + '%';

    // th·ªùi gian c√≤n l·∫°i
    if (!round.startTime || !round.endTime || round.status === 'waiting') {
      timeRemainingEl.textContent = 'ch∆∞a b·∫Øt ƒë·∫ßu';
      roundStatusEl.textContent =
        `ƒêang ch·ªù ƒë·ªß ng∆∞·ªùi (‚â• 2) ƒë·ªÉ b·∫Øt ƒë·∫ßu ƒë·∫øm ${config.betDurationSec} gi√¢y`;
    } else {
      const now = Math.floor(Date.now() / 1000);
      let remain = round.endTime - now;
      if (remain < 0) remain = 0;
      timeRemainingEl.textContent = remain + ' gi√¢y';
      roundStatusEl.textContent = 'ƒêang ch·∫°y...';
    }

    // render b·∫£ng ng∆∞·ªùi ch∆°i
    playersTableBody.innerHTML = '';
    const sorted = [...round.players].filter(p => p.gold > 0)
      .sort((a, b) => b.gold - a.gold);

    sorted.forEach((p, idx) => {
      const tr = document.createElement('tr');
      const chance = round.totalGold > 0 ? (p.gold / round.totalGold) * 100 : 0;
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${p.name}</td>
        <td>${p.gold}</td>
        <td>${chance.toFixed(2)}%</td>
      `;
      playersTableBody.appendChild(tr);
    });

    // admin panel
    if (currentPlayerName && currentPlayerName.toLowerCase() === 'admin') {
      adminPanelEl.style.display = 'block';
      configDurationInput.value = config.betDurationSec;
      configMinBetInput.value = config.minBet;
      betAmountInput.min = config.minBet;
    } else {
      adminPanelEl.style.display = 'none';
      betAmountInput.min = config.minBet;
    }
  }

  // setName
  document.getElementById('setPlayerBtn').addEventListener('click', () => {
    const name = document.getElementById('playerName').value.trim();
    if (!name) {
      alert('H√£y nh·∫≠p t√™n ng∆∞·ªùi ch∆°i tr∆∞·ªõc.');
      return;
    }
    currentPlayerName = name;
    currentPlayerNameEl.textContent = currentPlayerName;
    winnerMessageEl.textContent = '';
    socket.emit('setName', name);
    renderState();
  });

  // placeBet
  document.getElementById('betBtn').addEventListener('click', () => {
    if (!currentPlayerName) {
      alert('B·∫°n ph·∫£i nh·∫≠p v√† x√°c nh·∫≠n t√™n tr∆∞·ªõc khi ƒë·∫∑t v√†ng.');
      return;
    }
    const val = parseInt(betAmountInput.value, 10);
    if (isNaN(val)) return;
    socket.emit('placeBet', val);
  });

  // admin save config
  document.getElementById('saveConfigBtn').addEventListener('click', () => {
    const dur = parseInt(configDurationInput.value, 10);
    const minB = parseInt(configMinBetInput.value, 10);
    socket.emit('saveConfig', {
      betDurationSec: dur,
      minBet: minB
    });
    alert('ƒê√£ g·ª≠i c·∫•u h√¨nh m·ªõi l√™n server');
  });
</script>
</body>
</html>
